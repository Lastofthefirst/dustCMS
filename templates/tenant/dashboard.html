<div id="app" class="min-h-screen bg-base-200">
  <!-- Mobile-first navbar -->
  <div class="navbar bg-base-100 shadow-lg sticky top-0 z-50">
    <div class="navbar-start">
      <button id="back-btn" class="btn btn-ghost btn-sm" onclick="navigateBack()" style="display: none;">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back
      </button>
    </div>
    <div class="navbar-center">
      <span id="nav-title" class="text-lg font-bold">{{TENANT_NAME}}</span>
    </div>
    <div class="navbar-end">
      <button class="btn btn-ghost btn-sm" onclick="logout()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
        <span class="hidden sm:inline ml-1">Logout</span>
      </button>
    </div>
  </div>

  <!-- Main content container -->
  <div id="main-content" class="container mx-auto p-4 max-w-4xl pb-20">
    <!-- Content loaded dynamically -->
  </div>
</div>

<script>
  const TENANT_SLUG = '{{TENANT_SLUG}}';
  const TENANT_NAME = '{{TENANT_NAME}}';
  const BASE_URL = window.location.origin;

  // App state
  let currentView = 'models-list';
  let currentModel = null;
  let currentItem = null;
  let models = [];
  let contentItems = [];

  // Navigation
  function navigateBack() {
    if (currentView === 'content-list' || currentView === 'content-edit-singleton') {
      showModelsList();
    } else if (currentView === 'content-edit') {
      showContentList(currentModel);
    }
  }

  function updateNavigation(title, showBack) {
    document.getElementById('nav-title').textContent = title;
    document.getElementById('back-btn').style.display = showBack ? 'flex' : 'none';
  }

  // Views
  async function showModelsList() {
    currentView = 'models-list';
    currentModel = null;
    updateNavigation(TENANT_NAME, false);

    try {
      const response = await fetch(`/api/content/${TENANT_SLUG}/models`);
      const data = await response.json();
      models = data.models || [];
      renderModelsList();
    } catch (error) {
      console.error('Failed to load models:', error);
      showError('Failed to load content models');
    }
  }

  function renderModelsList() {
    const content = document.getElementById('main-content');

    if (models.length === 0) {
      content.innerHTML = `
        <div class="flex flex-col items-center justify-center min-h-[50vh] text-center px-4">
          <svg class="w-16 h-16 text-base-content/30 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
          </svg>
          <h2 class="text-2xl font-bold mb-2">Your Site Isn't Set Up Yet</h2>
          <p class="text-base-content/70">Your site administrator needs to create content models before you can add content.</p>
          <p class="text-base-content/70 text-sm mt-2">Please contact your administrator for help.</p>
        </div>
      `;
      return;
    }

    content.innerHTML = `
      <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold mb-2">Content Management</h1>
        <p class="text-base-content/70">Choose a content model to manage</p>
      </div>

      <div class="grid gap-4">
        ${models.map(model => `
          <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onclick="handleModelClick('${model.slug}')">
            <div class="card-body p-4 sm:p-6">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="card-title text-lg sm:text-xl mb-1">${escapeHtml(model.name)}</h3>
                  <div class="flex flex-wrap gap-2 mt-2">
                    <span class="badge badge-sm ${model.type === 'collection' ? 'badge-primary' : 'badge-secondary'}">
                      ${model.type === 'collection' ? 'Collection' : 'Singleton'}
                    </span>
                    <span class="badge badge-sm badge-outline">${model.fields.length} fields</span>
                  </div>
                </div>
                <svg class="w-6 h-6 text-base-content/50 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  async function handleModelClick(slug) {
    currentModel = models.find(m => m.slug === slug);
    if (!currentModel) return;

    if (currentModel.type === 'singleton') {
      // Load and edit the singleton directly
      await loadSingletonContent(slug);
    } else {
      // Show list of items for collection
      await showContentList(currentModel);
    }
  }

  async function loadSingletonContent(slug) {
    currentView = 'content-edit-singleton';
    updateNavigation(currentModel.name, true);

    try {
      const response = await fetch(`/api/content/${TENANT_SLUG}/${slug}`);
      const data = await response.json();
      currentItem = data.content || {};
      renderContentForm(true);
    } catch (error) {
      console.error('Failed to load content:', error);
      showError('Failed to load content');
    }
  }

  async function showContentList(model) {
    currentView = 'content-list';
    currentModel = model;
    updateNavigation(model.name, true);

    try {
      const response = await fetch(`/api/content/${TENANT_SLUG}/${model.slug}`);
      const data = await response.json();
      contentItems = data.items || [];
      renderContentList();
    } catch (error) {
      console.error('Failed to load content:', error);
      showError('Failed to load content items');
    }
  }

  function renderContentList() {
    const content = document.getElementById('main-content');

    content.innerHTML = `
      <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl sm:text-2xl font-bold">${escapeHtml(currentModel.name)}</h2>
          <button class="btn btn-primary btn-sm sm:btn-md" onclick="createNewItem()">
            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="hidden sm:inline ml-1">New</span>
          </button>
        </div>
      </div>

      ${contentItems.length === 0 ? `
        <div class="flex flex-col items-center justify-center min-h-[40vh] text-center px-4">
          <svg class="w-16 h-16 text-base-content/30 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <h3 class="text-xl font-bold mb-2">No Items Yet</h3>
          <p class="text-base-content/70 mb-4">Start by creating your first item</p>
          <button class="btn btn-primary" onclick="createNewItem()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create First Item
          </button>
        </div>
      ` : `
        <div class="grid gap-3">
          ${contentItems.map(item => renderContentCard(item)).join('')}
        </div>
      `}
    `;
  }

  function renderContentCard(item) {
    // Get a preview of the item (first text/textarea field)
    const previewField = currentModel.fields.find(f => f.type === 'text' || f.type === 'textarea');
    const preview = previewField ? (item[previewField.name] || '') : '';
    const truncatedPreview = preview.length > 100 ? preview.substring(0, 100) + '...' : preview;

    return `
      <div class="card bg-base-100 shadow hover:shadow-lg transition-shadow">
        <div class="card-body p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0" onclick="editItem(${item.id})">
              <div class="font-semibold text-base sm:text-lg mb-1 cursor-pointer hover:text-primary truncate">
                ${escapeHtml(preview || 'Untitled')}
              </div>
              ${truncatedPreview && truncatedPreview !== preview ? `
                <p class="text-sm text-base-content/70 line-clamp-2">${escapeHtml(truncatedPreview)}</p>
              ` : ''}
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button class="btn btn-ghost btn-sm btn-square" onclick="editItem(${item.id})" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button class="btn btn-ghost btn-sm btn-square text-error" onclick="deleteItem(${item.id})" title="Delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function createNewItem() {
    currentItem = {};
    currentView = 'content-edit';
    updateNavigation('New Item', true);
    renderContentForm(false);
  }

  function editItem(id) {
    currentItem = contentItems.find(item => item.id === id);
    if (!currentItem) return;
    currentView = 'content-edit';
    updateNavigation('Edit Item', true);
    renderContentForm(false);
  }

  function renderContentForm(isSingleton) {
    const content = document.getElementById('main-content');

    const isNewItem = !currentItem.id;

    content.innerHTML = `
      <form id="content-form" onsubmit="saveContent(event)" class="space-y-4">
        ${isNewItem ? `
          <!-- LLM Import Helper -->
          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
              <h3 class="font-bold">Quick Entry with AI</h3>
              <div class="text-sm mt-1">Get help from an AI to format your content</div>
            </div>
            <div class="flex gap-2">
              <button type="button" class="btn btn-sm btn-outline" onclick="copyContentLLMPrompt(event)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                <span class="hidden sm:inline ml-1">Copy Prompt</span>
              </button>
              <button type="button" class="btn btn-sm btn-primary" onclick="showImportContentModal()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                <span class="hidden sm:inline ml-1">Import Data</span>
              </button>
            </div>
          </div>
        ` : ''}

        <div class="card bg-base-100 shadow-lg">
          <div class="card-body p-4 sm:p-6">
            <h2 class="card-title text-xl sm:text-2xl mb-4">
              ${isSingleton ? escapeHtml(currentModel.name) : (currentItem.id ? 'Edit Item' : 'New Item')}
            </h2>

            <div class="space-y-4">
              ${currentModel.fields.map(field => renderField(field)).join('')}
            </div>

            <div class="card-actions justify-end mt-6 pt-4 border-t gap-2">
              <button type="button" class="btn btn-ghost" onclick="navigateBack()">Cancel</button>
              <button type="submit" class="btn btn-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Save
              </button>
            </div>
          </div>
        </div>
      </form>
    `;
  }

  function renderField(field) {
    const value = currentItem[field.name] || '';
    const label = field.label || field.name;
    const required = field.required ? 'required' : '';
    const requiredMark = field.required ? '<span class="text-error">*</span>' : '';

    switch (field.type) {
      case 'text':
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
              ${field.maxLength ? `<span class="label-text-alt text-base-content/50">${field.maxLength} max</span>` : ''}
            </label>
            <input
              type="text"
              name="${field.name}"
              value="${escapeHtml(value)}"
              ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
              class="input input-bordered w-full"
              ${required}
            />
          </div>
        `;

      case 'textarea':
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
              ${field.maxLength ? `<span class="label-text-alt text-base-content/50">${field.maxLength} max</span>` : ''}
            </label>
            <textarea
              name="${field.name}"
              rows="4"
              ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
              class="textarea textarea-bordered w-full"
              ${required}
            >${escapeHtml(value)}</textarea>
          </div>
        `;

      case 'markdown':
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
              <span class="label-text-alt text-base-content/50">Markdown supported</span>
            </label>
            <textarea
              name="${field.name}"
              rows="8"
              class="textarea textarea-bordered w-full font-mono text-sm"
              ${required}
            >${escapeHtml(value)}</textarea>
          </div>
        `;

      case 'image':
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
            </label>
            <input
              type="text"
              name="${field.name}"
              id="image-${field.name}"
              value="${escapeHtml(value)}"
              placeholder="Select or upload an image"
              class="input input-bordered w-full"
              ${required}
              readonly
            />
            <div class="mt-2 flex gap-2">
              <button type="button" class="btn btn-sm btn-outline" onclick="openImagePicker('${field.name}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Choose Image
              </button>
              ${value ? `
                <button type="button" class="btn btn-sm btn-ghost text-error" onclick="clearImage('${field.name}')">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                  Clear
                </button>
              ` : ''}
            </div>
            ${value ? `
              <div class="mt-2">
                <img src="/images/${escapeHtml(value)}" alt="Preview" class="max-w-xs max-h-48 rounded-lg shadow">
              </div>
            ` : ''}
          </div>
        `;

      case 'date':
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
            </label>
            <input
              type="date"
              name="${field.name}"
              value="${escapeHtml(value)}"
              class="input input-bordered w-full"
              ${required}
            />
          </div>
        `;

      case 'link':
        const linkValue = typeof value === 'object' ? value : { url: '', text: '' };
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
            </label>
            <div class="space-y-2">
              <input
                type="url"
                name="${field.name}_url"
                value="${escapeHtml(linkValue.url || '')}"
                placeholder="URL"
                class="input input-bordered w-full"
                ${required}
              />
              <input
                type="text"
                name="${field.name}_text"
                value="${escapeHtml(linkValue.text || '')}"
                placeholder="Link text (optional)"
                class="input input-bordered w-full"
              />
            </div>
          </div>
        `;

      case 'badges':
        const badges = Array.isArray(value) ? value : [];
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)} ${requiredMark}</span>
              <span class="label-text-alt text-base-content/50">One per line</span>
            </label>
            <textarea
              name="${field.name}"
              rows="3"
              class="textarea textarea-bordered w-full"
              placeholder="badge1&#10;badge2&#10;badge3"
              ${required}
            >${badges.join('\n')}</textarea>
          </div>
        `;

      default:
        return `<div class="text-error">Unknown field type: ${field.type}</div>`;
    }
  }

  async function saveContent(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = {};

    // Process form data
    currentModel.fields.forEach(field => {
      if (field.type === 'link') {
        data[field.name] = {
          url: formData.get(`${field.name}_url`) || '',
          text: formData.get(`${field.name}_text`) || ''
        };
      } else if (field.type === 'badges') {
        const text = formData.get(field.name) || '';
        data[field.name] = text.split('\n').map(s => s.trim()).filter(s => s);
      } else {
        data[field.name] = formData.get(field.name) || '';
      }
    });

    try {
      const isSingleton = currentModel.type === 'singleton';
      const isEdit = currentItem.id !== undefined;

      let response;
      if (isSingleton) {
        response = await fetch(`/api/content/${TENANT_SLUG}/${currentModel.slug}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else if (isEdit) {
        response = await fetch(`/api/content/${TENANT_SLUG}/${currentModel.slug}/${currentItem.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else {
        response = await fetch(`/api/content/${TENANT_SLUG}/${currentModel.slug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      }

      if (!response.ok) {
        throw new Error('Failed to save content');
      }

      // Navigate back
      if (isSingleton) {
        showModelsList();
      } else {
        showContentList(currentModel);
      }
    } catch (error) {
      console.error('Failed to save content:', error);
      alert('Failed to save content. Please try again.');
    }
  }

  async function deleteItem(id) {
    if (!confirm('Are you sure you want to delete this item?')) {
      return;
    }

    try {
      const response = await fetch(`/api/content/${TENANT_SLUG}/${currentModel.slug}/${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error('Failed to delete item');
      }

      // Reload list
      await showContentList(currentModel);
    } catch (error) {
      console.error('Failed to delete item:', error);
      alert('Failed to delete item. Please try again.');
    }
  }

  async function logout() {
    await fetch('/api/tenant/auth/logout', { method: 'POST' });
    window.location.href = '/login';
  }

  function showError(message) {
    document.getElementById('main-content').innerHTML = `
      <div class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>${escapeHtml(message)}</span>
      </div>
    `;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Image picker state
  let currentImageField = null;
  let availableImages = [];

  async function openImagePicker(fieldName) {
    currentImageField = fieldName;

    // Load images
    try {
      const response = await fetch('/api/tenant/images');
      const data = await response.json();
      availableImages = data.images || [];
      showImagePickerModal();
    } catch (error) {
      console.error('Failed to load images:', error);
      alert('Failed to load images');
    }
  }

  function showImagePickerModal() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('image-picker-modal');
    if (!modal) {
      modal = document.createElement('dialog');
      modal.id = 'image-picker-modal';
      modal.className = 'modal';
      document.body.appendChild(modal);
    }

    modal.innerHTML = `
      <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg mb-4">Choose an Image</h3>

        <!-- Upload section -->
        <div class="mb-6">
          <label class="btn btn-primary btn-sm">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Upload New Image
            <input type="file" accept="image/*" onchange="uploadImage(event)" class="hidden" />
          </label>
          <span id="upload-status" class="ml-3 text-sm"></span>
        </div>

        <!-- Images grid -->
        <div class="max-h-96 overflow-y-auto">
          ${availableImages.length === 0 ? `
            <div class="text-center py-8 text-base-content/50">
              <svg class="w-16 h-16 mx-auto mb-2 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p>No images yet. Upload your first image above.</p>
            </div>
          ` : `
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              ${availableImages.map(image => `
                <div class="card bg-base-200 cursor-pointer hover:ring-2 hover:ring-primary transition-all" onclick="selectImage('${image.filename}')">
                  <figure class="aspect-square">
                    <img src="/images/${image.filename}" alt="${image.filename}" class="w-full h-full object-cover" />
                  </figure>
                  <div class="card-body p-2">
                    <p class="text-xs truncate" title="${image.filename}">${image.filename}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>

        <div class="modal-action">
          <button class="btn btn-ghost" onclick="closeImagePicker()">Cancel</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button onclick="closeImagePicker()">close</button>
      </form>
    `;

    modal.showModal();
  }

  function selectImage(filename) {
    if (currentImageField) {
      const input = document.getElementById(`image-${currentImageField}`);
      if (input) {
        input.value = filename;
        // Trigger re-render to show preview
        renderContentForm(currentModel.type === 'singleton');
      }
    }
    closeImagePicker();
  }

  function clearImage(fieldName) {
    const input = document.getElementById(`image-${fieldName}`);
    if (input) {
      input.value = '';
      renderContentForm(currentModel.type === 'singleton');
    }
  }

  async function uploadImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    const statusEl = document.getElementById('upload-status');
    statusEl.textContent = 'Uploading...';
    statusEl.className = 'ml-3 text-sm text-info';

    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/api/tenant/images', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Upload failed');
      }

      statusEl.textContent = 'Uploaded successfully!';
      statusEl.className = 'ml-3 text-sm text-success';

      // Reload images and refresh picker
      const imagesResponse = await fetch('/api/tenant/images');
      const imagesData = await imagesResponse.json();
      availableImages = imagesData.images || [];

      // Auto-select the newly uploaded image
      selectImage(data.filename);
    } catch (error) {
      console.error('Upload failed:', error);
      statusEl.textContent = 'Upload failed';
      statusEl.className = 'ml-3 text-sm text-error';
    }

    // Reset file input
    event.target.value = '';
  }

  function closeImagePicker() {
    const modal = document.getElementById('image-picker-modal');
    if (modal) {
      modal.close();
    }
    currentImageField = null;
  }

  // LLM content import
  async function copyContentLLMPrompt(e) {
    if (!currentModel) return;

    const fieldDescriptions = currentModel.fields.map(field => {
      let desc = `  - ${field.name} (${field.type})`;
      if (field.required) desc += ' [REQUIRED]';
      if (field.maxLength) desc += ` [max ${field.maxLength} characters]`;
      if (field.label) desc += ` - ${field.label}`;

      // Add type-specific guidance
      if (field.type === 'link') {
        desc += '\n    Format: {"url": "https://...", "text": "link text"}';
      } else if (field.type === 'badges') {
        desc += '\n    Format: array of strings, e.g., ["badge1", "badge2"]';
      } else if (field.type === 'image') {
        desc += '\n    Format: filename only (e.g., "photo.jpg")';
      } else if (field.type === 'date') {
        desc += '\n    Format: YYYY-MM-DD';
      }

      return desc;
    }).join('\n');

    const prompt = `You are a content formatter for a CMS. The user will describe their content, and you should format it as JSON matching this structure:

Content Model: ${currentModel.name}
Type: ${currentModel.type === 'collection' ? 'Collection Item' : 'Singleton'}

Fields:
${fieldDescriptions}

Instructions:
1. Read the user's description carefully
2. Extract relevant information for each field
3. Return ONLY valid JSON with the field names as keys
4. For required fields, ensure you provide a value
5. For link fields, use the object format shown above
6. For badges, provide an array of strings
7. For images, use filename only (user will upload separately)
8. For dates, use YYYY-MM-DD format
9. Keep text within character limits if specified

Example response format:
{
  "field1": "value1",
  "field2": "value2",
  ...
}

Remember: Return ONLY the JSON object, no additional text or explanation.

User's content description:`;

    try {
      await navigator.clipboard.writeText(prompt);
      const btn = e.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span class="hidden sm:inline ml-1">Copied!</span>
      `;
      btn.classList.add('btn-success');
      btn.classList.remove('btn-outline');

      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline');
      }, 3000);
    } catch (error) {
      alert('Failed to copy prompt');
    }
  }

  async function showImportContentModal() {
    let modal = document.getElementById('import-content-modal');
    if (!modal) {
      modal = document.createElement('dialog');
      modal.id = 'import-content-modal';
      modal.className = 'modal';
      document.body.appendChild(modal);
    }

    // Try to read from clipboard automatically
    let clipboardText = '';
    try {
      clipboardText = await navigator.clipboard.readText();
    } catch (error) {
      console.log('Clipboard access not available');
    }

    modal.innerHTML = `
      <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Import Content Data</h3>

        <div class="space-y-4">
          <div>
            <p class="text-sm text-base-content/70 mb-2">
              Paste the JSON response from your AI here:
            </p>
            <textarea
              id="import-content-json"
              rows="10"
              class="textarea textarea-bordered w-full font-mono text-sm"
              placeholder='{"field1": "value1", "field2": "value2"}'
            >${clipboardText}</textarea>
          </div>

          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-sm">
              <strong>How to use:</strong>
              <ol class="list-decimal list-inside mt-1">
                <li>Click "Copy Prompt" to get the AI instruction</li>
                <li>Paste it into your AI chat (ChatGPT, Claude, etc.)</li>
                <li>Describe your content to the AI</li>
                <li>Copy the JSON response and paste it here</li>
              </ol>
            </div>
          </div>
        </div>

        <div class="modal-action">
          <button class="btn btn-ghost" onclick="closeImportContentModal()">Cancel</button>
          <button class="btn btn-primary" onclick="importContentData()">Import</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button onclick="closeImportContentModal()">close</button>
      </form>
    `;

    modal.showModal();
  }

  function importContentData() {
    const textarea = document.getElementById('import-content-json');
    const jsonText = textarea.value.trim();

    if (!jsonText) {
      alert('Please paste the JSON data');
      return;
    }

    try {
      const data = JSON.parse(jsonText);

      // Validate that it's an object
      if (typeof data !== 'object' || Array.isArray(data)) {
        throw new Error('Expected a JSON object');
      }

      // Merge imported data with current item
      currentItem = { ...currentItem, ...data };

      // Close modal and re-render form with imported data
      closeImportContentModal();
      renderContentForm(currentModel.type === 'singleton');
    } catch (error) {
      alert('Invalid JSON format. Please check the data and try again.\n\nError: ' + error.message);
    }
  }

  function closeImportContentModal() {
    const modal = document.getElementById('import-content-modal');
    if (modal) {
      modal.close();
    }
  }

  // Initialize app
  showModelsList();
</script>

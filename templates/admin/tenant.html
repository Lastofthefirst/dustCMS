<div class="min-h-screen bg-base-200">
  <!-- Navbar -->
  <div class="navbar bg-base-100 shadow-lg">
    <div class="flex-1">
      <a href="/admin" class="btn btn-ghost gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back
      </a>
      <span class="text-xl font-bold ml-4">{{TENANT_NAME}}</span>
    </div>
    <div class="flex-none gap-2">
      <div class="badge badge-primary">{{TENANT_SLUG}}</div>
      <button class="btn btn-ghost" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto p-6 max-w-7xl">
    <!-- Tabs -->
    <div role="tablist" class="tabs tabs-boxed mb-6">
      <a role="tab" class="tab tab-active" id="content-tab" onclick="switchTab('content')">Content Management</a>
      <a role="tab" class="tab" id="models-tab" onclick="switchTab('models')">Content Models</a>
      <a role="tab" class="tab" id="images-tab" onclick="switchTab('images')">Media Library</a>
    </div>

    <!-- Content Tab -->
    <div id="content-panel" class="fade-in">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-3xl font-bold">Content</h2>
          <p class="text-base-content/70">Manage your content items</p>
        </div>
      </div>

      <div id="content-models-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <!-- Content models will be loaded here -->
      </div>
    </div>

    <!-- Models Tab -->
    <div id="models-panel" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-3xl font-bold">Content Models</h2>
          <p class="text-base-content/70">Define your content structure</p>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-outline gap-2" onclick="copyLLMPrompt()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            LLM Prompt
          </button>
          <button class="btn btn-outline gap-2" onclick="showImportModelModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            Import Model
          </button>
          <button class="btn btn-primary gap-2" onclick="showCreateModelModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create Model
          </button>
        </div>
      </div>

      <div id="models-list" class="space-y-4">
        <!-- Models will be loaded here -->
      </div>
    </div>

    <!-- Images Tab -->
    <div id="images-panel" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-3xl font-bold">Media Library</h2>
          <p class="text-base-content/70">Upload and manage images</p>
        </div>
        <button class="btn btn-primary gap-2" onclick="document.getElementById('image-upload').click()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload Image
        </button>
        <input type="file" id="image-upload" class="hidden" accept="image/*" onchange="uploadImage(event)" />
      </div>

      <div id="images-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <!-- Images will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Create Model Modal -->
<dialog id="create-model-modal" class="modal">
  <div class="modal-box max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Create Content Model</h3>
    <form id="create-model-form" class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Model Slug</span></label>
          <input type="text" id="model-slug" class="input input-bordered" placeholder="events" pattern="[a-z0-9_]+" required />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Model Name</span></label>
          <input type="text" id="model-name" class="input input-bordered" placeholder="Events" required />
        </div>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Type</span></label>
        <select id="model-type" class="select select-bordered">
          <option value="collection">Collection (Multiple Items)</option>
          <option value="singleton">Singleton (Single Item)</option>
        </select>
      </div>

      <div class="divider">Fields</div>
      <div id="fields-list" class="space-y-2"></div>
      <button type="button" class="btn btn-sm btn-outline" onclick="addField()">+ Add Field</button>

      <div class="modal-action">
        <button type="button" class="btn" onclick="closeCreateModelModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Model</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Import Model Modal -->
<dialog id="import-model-modal" class="modal">
  <div class="modal-box max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Import Content Model from JSON</h3>
    <form id="import-model-form" class="space-y-4">
      <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="text-sm">
          <p>Use the <strong>LLM Prompt</strong> button to generate a prompt, then paste it into an AI assistant.</p>
          <p>Describe your content needs, and the AI will generate the JSON to paste here.</p>
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Content Model JSON</span>
        </label>
        <textarea
          id="import-json"
          class="textarea textarea-bordered font-mono text-sm h-64"
          placeholder='Paste JSON here...'
          required
        ></textarea>
        <label class="label">
          <span class="label-text-alt">JSON format: {"slug": "...", "name": "...", "type": "collection|singleton", "fields": [...]}</span>
        </label>
      </div>

      <div id="import-error" class="alert alert-error hidden">
        <span id="import-error-text"></span>
      </div>

      <div class="modal-action">
        <button type="button" class="btn" onclick="closeImportModelModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Import Model</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Content List Modal -->
<dialog id="content-list-modal" class="modal">
  <div class="modal-box max-w-5xl max-h-[90vh]">
    <h3 class="font-bold text-2xl mb-4" id="content-list-title"></h3>
    <div class="flex justify-between items-center mb-4">
      <p class="text-base-content/70" id="content-list-subtitle"></p>
      <button class="btn btn-primary btn-sm gap-2" onclick="createNewContent()" id="create-content-btn">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add Item
      </button>
    </div>
    <div id="content-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
    <div class="modal-action">
      <button class="btn" onclick="closeContentListModal()">Close</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- Edit Content Modal -->
<dialog id="edit-content-modal" class="modal">
  <div class="modal-box max-w-2xl max-h-[90vh] overflow-y-auto">
    <h3 class="font-bold text-lg mb-4" id="edit-content-title">Edit Content</h3>
    <form id="edit-content-form" class="space-y-4">
      <div id="content-fields" class="space-y-4"></div>
      <div class="modal-action">
        <button type="button" class="btn" onclick="closeEditContentModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
  const TENANT_SLUG = '{{TENANT_SLUG}}';
  let currentTab = 'content';
  let models = [];
  let images = [];
  let fieldCounter = 0;
  let currentModel = null;
  let currentItem = null;

  async function loadModels() {
    const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/models`);
    const data = await response.json();
    models = data.models || [];
    renderContentModels();
    renderModels();
  }

  async function loadImages() {
    const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/images`);
    const data = await response.json();
    images = data.images || [];
    renderImages();
  }

  function renderContentModels() {
    const list = document.getElementById('content-models-list');
    if (models.length === 0) {
      list.innerHTML = '<div class="col-span-full text-center py-12 text-base-content/50">No content models yet. Create one in the Models tab!</div>';
      return;
    }
    list.innerHTML = models.map(model => `
      <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer" onclick="openContentEditor('${model.slug}')">
        <div class="card-body">
          <h3 class="card-title">${escapeHtml(model.name)}</h3>
          <p class="text-sm text-base-content/70">${model.type === 'collection' ? 'Collection' : 'Singleton'}</p>
          <div class="badge badge-outline mt-2">${model.fields.length} fields</div>
        </div>
      </div>
    `).join('');
  }

  function renderModels() {
    const list = document.getElementById('models-list');
    if (models.length === 0) {
      list.innerHTML = '<div class="text-center py-12 text-base-content/50">No content models yet. Create your first one!</div>';
      return;
    }
    list.innerHTML = models.map(model => `
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="card-title">${escapeHtml(model.name)}</h3>
              <p class="text-sm text-base-content/70 font-mono">${escapeHtml(model.slug)}</p>
              <div class="mt-2"><span class="badge">${model.type}</span></div>
              <div class="mt-3 space-y-1">
                ${model.fields.map(f => `<div class="text-sm"><span class="badge badge-sm badge-ghost">${f.type}</span> ${escapeHtml(f.name)}</div>`).join('')}
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <button class="btn btn-primary btn-sm gap-2" onclick="showIntegrationModal('${model.slug}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                API Code
              </button>
              <button class="btn btn-error btn-sm btn-outline" onclick="deleteModel('${model.slug}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderImages() {
    const grid = document.getElementById('images-grid');
    if (images.length === 0) {
      grid.innerHTML = '<div class="col-span-full text-center py-12 text-base-content/50">No images uploaded yet</div>';
      return;
    }
    grid.innerHTML = images.map(img => `
      <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow">
        <figure class="aspect-square bg-base-200">
          <img src="/images/${img}" alt="${img}" class="w-full h-full object-cover" />
        </figure>
        <div class="card-body p-2">
          <button class="btn btn-xs btn-block" onclick="copyImageUrl('${img}')">Copy URL</button>
        </div>
      </div>
    `).join('');
  }

  function switchTab(tab) {
    currentTab = tab;
    ['content', 'models', 'images'].forEach(t => {
      document.getElementById(`${t}-tab`).classList.toggle('tab-active', t === tab);
      document.getElementById(`${t}-panel`).classList.toggle('hidden', t !== tab);
    });
    if (tab === 'images') loadImages();
  }

  function showCreateModelModal() {
    document.getElementById('fields-list').innerHTML = '';
    fieldCounter = 0;
    addField();
    document.getElementById('create-model-modal').showModal();
  }

  function closeCreateModelModal() {
    document.getElementById('create-model-modal').close();
    document.getElementById('create-model-form').reset();
  }

  function showImportModelModal() {
    document.getElementById('import-model-modal').showModal();
  }

  function closeImportModelModal() {
    document.getElementById('import-model-modal').close();
    document.getElementById('import-model-form').reset();
    document.getElementById('import-error').classList.add('hidden');
  }

  async function copyLLMPrompt() {
    const prompt = `You are a content model generator for a headless CMS. Generate a content model in JSON format based on the user's description.

The JSON should follow this exact structure:
{
  "slug": "lowercase-slug-with-hyphens",
  "name": "Display Name",
  "type": "collection" or "singleton",
  "fields": [
    {
      "name": "field_name",
      "type": "text|textarea|markdown|image|date|link|badges",
      "required": true or false,
      "label": "Field Label (optional)",
      "maxLength": 100 (optional, for text/textarea only)
    }
  ]
}

Field types:
- text: Single-line text input
- textarea: Multi-line text
- markdown: Markdown editor
- image: Image URL (users upload to media library)
- date: Date picker
- link: URL with optional text
- badges: Comma-separated tags

Model types:
- collection: Multiple items (e.g., blog posts, products)
- singleton: Single item (e.g., site settings, about page)

Instructions:
1. Listen to the user's content model description
2. Generate ONLY the JSON (no explanations, no markdown code blocks)
3. Use appropriate field types
4. Set required fields appropriately
5. Use descriptive labels

Now, describe the content model you need:`;

    try {
      await navigator.clipboard.writeText(prompt);
      const btn = event.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!';
      btn.classList.add('btn-success');
      btn.classList.remove('btn-outline');

      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline');
      }, 3000);
    } catch (error) {
      alert('Failed to copy prompt. Please try again.');
    }
  }

  function addField() {
    const id = fieldCounter++;
    const container = document.getElementById('fields-list');
    const div = document.createElement('div');
    div.className = 'space-y-2 p-3 bg-base-200 rounded-lg';
    div.innerHTML = `
      <div class="grid grid-cols-3 gap-2">
        <input type="text" class="input input-sm input-bordered" placeholder="Field name" data-field-name="${id}" required />
        <select class="select select-sm select-bordered" data-field-type="${id}" onchange="toggleCharLimit(${id})">
          <option value="text">Text</option>
          <option value="textarea">Textarea</option>
          <option value="markdown">Markdown</option>
          <option value="image">Image</option>
          <option value="date">Date</option>
          <option value="link">Link</option>
          <option value="badges">Badges (Tags)</option>
        </select>
        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" class="checkbox checkbox-sm" data-field-required="${id}" />
          <span class="label-text text-xs">Required</span>
        </label>
      </div>
      <div class="hidden" data-char-limit-container="${id}">
        <label class="label py-1">
          <span class="label-text text-xs">Character Limit (optional)</span>
        </label>
        <input type="number" class="input input-sm input-bordered w-full" placeholder="e.g., 100" min="1" data-field-maxlength="${id}" />
      </div>
    `;
    container.appendChild(div);
  }

  function toggleCharLimit(fieldId) {
    const typeSelect = document.querySelector(`[data-field-type="${fieldId}"]`);
    const charLimitContainer = document.querySelector(`[data-char-limit-container="${fieldId}"]`);
    const fieldType = typeSelect.value;

    // Show character limit input for text and textarea fields
    if (fieldType === 'text' || fieldType === 'textarea') {
      charLimitContainer.classList.remove('hidden');
    } else {
      charLimitContainer.classList.add('hidden');
    }
  }

  document.getElementById('create-model-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const slug = document.getElementById('model-slug').value.trim();
    const name = document.getElementById('model-name').value.trim();
    const type = document.getElementById('model-type').value;
    const fields = [];

    for (let i = 0; i < fieldCounter; i++) {
      const nameInput = document.querySelector(`[data-field-name="${i}"]`);
      const typeSelect = document.querySelector(`[data-field-type="${i}"]`);
      const requiredCheckbox = document.querySelector(`[data-field-required="${i}"]`);
      const maxLengthInput = document.querySelector(`[data-field-maxlength="${i}"]`);

      if (nameInput && nameInput.value) {
        const field = {
          name: nameInput.value.trim(),
          type: typeSelect.value,
          required: requiredCheckbox.checked
        };

        // Add maxLength if specified for text/textarea fields
        if (maxLengthInput && maxLengthInput.value && (typeSelect.value === 'text' || typeSelect.value === 'textarea')) {
          field.maxLength = parseInt(maxLengthInput.value, 10);
        }

        fields.push(field);
      }
    }

    const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/models`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ slug, name, type, fields })
    });

    if (response.ok) {
      closeCreateModelModal();
      loadModels();
    }
  });

  document.getElementById('import-model-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const jsonText = document.getElementById('import-json').value.trim();

    try {
      // Parse and validate JSON
      const modelData = JSON.parse(jsonText);

      // Validate required fields
      if (!modelData.slug || !modelData.name || !modelData.type || !modelData.fields) {
        throw new Error('Missing required fields: slug, name, type, or fields');
      }

      if (!Array.isArray(modelData.fields)) {
        throw new Error('Fields must be an array');
      }

      if (!['collection', 'singleton'].includes(modelData.type)) {
        throw new Error('Type must be "collection" or "singleton"');
      }

      // Validate each field
      for (const field of modelData.fields) {
        if (!field.name || !field.type) {
          throw new Error('Each field must have name and type');
        }
        const validTypes = ['text', 'textarea', 'markdown', 'image', 'date', 'link', 'badges'];
        if (!validTypes.includes(field.type)) {
          throw new Error(`Invalid field type: ${field.type}`);
        }
      }

      // Send to API
      const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/models`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(modelData)
      });

      const data = await response.json();

      if (response.ok) {
        closeImportModelModal();
        loadModels();
      } else {
        throw new Error(data.error || 'Failed to create model');
      }
    } catch (error) {
      document.getElementById('import-error-text').textContent = error.message;
      document.getElementById('import-error').classList.remove('hidden');
    }
  });

  async function deleteModel(slug) {
    if (!confirm(`Delete model "${slug}"? This will delete all content.`)) return;
    await fetch(`/api/admin/tenants/${TENANT_SLUG}/models/${slug}`, { method: 'DELETE' });
    loadModels();
  }

  async function openContentEditor(modelSlug) {
    currentModel = models.find(m => m.slug === modelSlug);
    if (!currentModel) return;

    document.getElementById('content-list-title').textContent = currentModel.name;
    document.getElementById('content-list-subtitle').textContent = currentModel.type === 'singleton' ? 'Single item' : 'Multiple items';
    document.getElementById('create-content-btn').style.display = currentModel.type === 'singleton' ? 'none' : 'block';

    await loadContentItems();
    document.getElementById('content-list-modal').showModal();
  }

  async function loadContentItems() {
    const endpoint = currentModel.type === 'singleton'
      ? `/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}/singleton`
      : `/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}`;

    const response = await fetch(endpoint);
    const data = await response.json();

    if (currentModel.type === 'singleton') {
      renderSingletonContent(data.item);
    } else {
      renderContentList(data.items || []);
    }
  }

  function renderContentList(items) {
    const list = document.getElementById('content-list');
    if (items.length === 0) {
      list.innerHTML = '<div class="text-center py-12 text-base-content/50">No content yet. Create your first item!</div>';
      return;
    }

    list.innerHTML = items.map(item => {
      const preview = currentModel.fields.slice(0, 2).map(f => {
        const value = item[f.name];
        if (!value) return '';
        if (f.type === 'image') return `<img src="${value}" class="w-12 h-12 object-cover rounded" />`;
        if (f.type === 'badges') return `<div class="flex gap-1">${value.split(',').slice(0, 3).map(b => `<span class="badge badge-sm">${escapeHtml(b.trim())}</span>`).join('')}</div>`;
        return `<span class="text-sm">${escapeHtml(String(value).substring(0, 50))}</span>`;
      }).join(' ');

      return `
        <div class="card bg-base-200 hover:bg-base-300 transition-colors">
          <div class="card-body p-4 flex flex-row items-center justify-between">
            <div class="flex gap-4 items-center flex-1">
              ${preview}
            </div>
            <div class="flex gap-2">
              <button class="btn btn-sm btn-ghost" onclick="editContent(${item.id})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button class="btn btn-sm btn-error btn-ghost" onclick="deleteContent(${item.id})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderSingletonContent(item) {
    const list = document.getElementById('content-list');
    const hasContent = item && Object.keys(item).length > 1; // More than just ID

    list.innerHTML = `
      <div class="text-center py-8">
        <button class="btn btn-primary btn-lg" onclick="editContent(null)">
          ${hasContent ? 'Edit Content' : 'Add Content'}
        </button>
      </div>
    `;
  }

  function createNewContent() {
    currentItem = null;
    showEditContentModal();
  }

  async function editContent(itemId) {
    if (currentModel.type === 'singleton') {
      const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}/singleton`);
      const data = await response.json();
      currentItem = data.item || {};
    } else if (itemId) {
      const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}/${itemId}`);
      const data = await response.json();
      currentItem = data.item;
    } else {
      currentItem = {};
    }

    showEditContentModal();
  }

  function showEditContentModal() {
    const isNew = !currentItem || !currentItem.id;
    document.getElementById('edit-content-title').textContent =
      isNew ? `Add ${currentModel.name}` : `Edit ${currentModel.name}`;

    const fieldsContainer = document.getElementById('content-fields');
    fieldsContainer.innerHTML = currentModel.fields.map(field => {
      const value = currentItem[field.name] || '';
      return generateFieldInput(field, value);
    }).join('');

    document.getElementById('edit-content-modal').showModal();
  }

  function generateFieldInput(field, value) {
    const required = field.required ? 'required' : '';
    const label = field.label || field.name;

    switch (field.type) {
      case 'text':
        const maxLengthAttr = field.maxLength ? `maxlength="${field.maxLength}"` : '';
        const charCountId = `char-count-${field.name}`;
        const currentLength = value ? String(value).length : 0;
        const showCounter = field.maxLength ? '' : 'hidden';
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)}</span>
              <span class="label-text-alt ${showCounter}" id="${charCountId}">${currentLength}${field.maxLength ? `/${field.maxLength}` : ''}</span>
            </label>
            <input type="text" name="${field.name}" class="input input-bordered" value="${escapeHtml(value)}"
              ${required} ${maxLengthAttr}
              oninput="updateCharCount('${field.name}', ${field.maxLength || 0})" />
          </div>
        `;
      case 'textarea':
        const textareaMaxLengthAttr = field.maxLength ? `maxlength="${field.maxLength}"` : '';
        const textareaCharCountId = `char-count-${field.name}`;
        const textareaCurrentLength = value ? String(value).length : 0;
        const textareaShowCounter = field.maxLength ? '' : 'hidden';
        return `
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">${escapeHtml(label)}</span>
              <span class="label-text-alt ${textareaShowCounter}" id="${textareaCharCountId}">${textareaCurrentLength}${field.maxLength ? `/${field.maxLength}` : ''}</span>
            </label>
            <textarea name="${field.name}" class="textarea textarea-bordered h-24" ${required} ${textareaMaxLengthAttr}
              oninput="updateCharCount('${field.name}', ${field.maxLength || 0})">${escapeHtml(value)}</textarea>
          </div>
        `;
      case 'markdown':
        return `
          <div class="form-control">
            <label class="label"><span class="label-text font-semibold">${escapeHtml(label)}</span></label>
            <textarea name="${field.name}" class="textarea textarea-bordered font-mono h-48" ${required}>${escapeHtml(value)}</textarea>
            <label class="label"><span class="label-text-alt">Supports Markdown formatting</span></label>
          </div>
        `;
      case 'image':
        return `
          <div class="form-control">
            <label class="label"><span class="label-text font-semibold">${escapeHtml(label)}</span></label>
            <input type="text" name="${field.name}" class="input input-bordered" value="${escapeHtml(value)}" placeholder="/images/filename.webp" ${required} />
            <label class="label"><span class="label-text-alt">Upload images in the Media Library tab</span></label>
          </div>
        `;
      case 'date':
        return `
          <div class="form-control">
            <label class="label"><span class="label-text font-semibold">${escapeHtml(label)}</span></label>
            <input type="date" name="${field.name}" class="input input-bordered" value="${value}" ${required} />
          </div>
        `;
      case 'link':
        const linkData = value ? (typeof value === 'string' ? JSON.parse(value) : value) : {url: '', text: ''};
        return `
          <div class="form-control">
            <label class="label"><span class="label-text font-semibold">${escapeHtml(label)}</span></label>
            <input type="url" name="${field.name}_url" class="input input-bordered mb-2" placeholder="https://example.com" value="${escapeHtml(linkData.url || '')}" ${required} />
            <input type="text" name="${field.name}_text" class="input input-bordered" placeholder="Link text (optional)" value="${escapeHtml(linkData.text || '')}" />
          </div>
        `;
      case 'badges':
        return `
          <div class="form-control">
            <label class="label"><span class="label-text font-semibold">${escapeHtml(label)}</span></label>
            <input type="text" name="${field.name}" class="input input-bordered" value="${escapeHtml(value)}" placeholder="tag1, tag2, tag3" ${required} />
            <label class="label"><span class="label-text-alt">Comma-separated tags</span></label>
          </div>
        `;
      default:
        return '';
    }
  }

  document.getElementById('edit-content-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {};

    currentModel.fields.forEach(field => {
      if (field.type === 'link') {
        const url = formData.get(`${field.name}_url`);
        const text = formData.get(`${field.name}_text`);
        data[field.name] = JSON.stringify({ url, text });
      } else {
        data[field.name] = formData.get(field.name);
      }
    });

    try {
      let response;
      if (currentModel.type === 'singleton') {
        response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else if (currentItem && currentItem.id) {
        response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}/${currentItem.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else {
        response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      }

      if (response.ok) {
        closeEditContentModal();
        await loadContentItems();
      }
    } catch (error) {
      alert('Failed to save content');
    }
  });

  async function deleteContent(itemId) {
    if (!confirm('Delete this item?')) return;

    const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/content/${currentModel.slug}/${itemId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      await loadContentItems();
    }
  }

  function closeContentListModal() {
    document.getElementById('content-list-modal').close();
  }

  function closeEditContentModal() {
    document.getElementById('edit-content-modal').close();
  }

  async function uploadImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/images`, {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      loadImages();
    }
    event.target.value = '';
  }

  function copyImageUrl(filename) {
    navigator.clipboard.writeText(`/images/${filename}`);
    alert('Image URL copied!');
  }

  function updateCharCount(fieldName, maxLength) {
    const input = document.querySelector(`[name="${fieldName}"]`);
    const counter = document.getElementById(`char-count-${fieldName}`);
    if (input && counter && maxLength > 0) {
      const currentLength = input.value.length;
      counter.textContent = `${currentLength}/${maxLength}`;

      // Add warning color if approaching limit
      if (currentLength >= maxLength * 0.9) {
        counter.classList.add('text-warning');
      } else {
        counter.classList.remove('text-warning');
      }
    }
  }

  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/admin/login';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  loadModels();
</script>
<!-- Integration Code Modal -->
<dialog id="integration-modal" class="modal">
  <div class="modal-box max-w-4xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>

    <h3 class="font-bold text-2xl mb-2" id="integration-title">API Integration</h3>
    <p class="text-base-content/70 mb-6">Use this content in your static site</p>

    <!-- API Endpoint -->
    <div class="mb-6">
      <label class="label">
        <span class="label-text font-semibold">API Endpoint</span>
      </label>
      <div class="flex gap-2">
        <input id="endpoint-url" readonly class="input input-bordered flex-1 font-mono text-sm" value="" />
        <button class="btn btn-primary" onclick="copyToClipboard('endpoint-url')">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
          Copy
        </button>
      </div>
    </div>

    <!-- Code Tabs -->
    <div role="tablist" class="tabs tabs-boxed mb-4">
      <a role="tab" class="tab tab-active" onclick="switchCodeTab('javascript')">JavaScript</a>
      <a role="tab" class="tab" onclick="switchCodeTab('html')">HTML</a>
      <a role="tab" class="tab" onclick="switchCodeTab('fetch')">Fetch API</a>
      <a role="tab" class="tab" onclick="switchCodeTab('curl')">cURL</a>
    </div>

    <!-- Code Snippets -->
    <div id="code-snippets">
      <div id="snippet-javascript" class="code-snippet">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-semibold">JavaScript Example</span>
          <button class="btn btn-sm btn-ghost" onclick="copyCodeSnippet('javascript')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Copy Code
          </button>
        </div>
        <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto"><code id="code-javascript" class="text-sm"></code></pre>
      </div>

      <div id="snippet-html" class="code-snippet hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-semibold">HTML Example</span>
          <button class="btn btn-sm btn-ghost" onclick="copyCodeSnippet('html')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Copy Code
          </button>
        </div>
        <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto"><code id="code-html" class="text-sm"></code></pre>
      </div>

      <div id="snippet-fetch" class="code-snippet hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-semibold">Fetch API Example</span>
          <button class="btn btn-sm btn-ghost" onclick="copyCodeSnippet('fetch')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Copy Code
          </button>
        </div>
        <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto"><code id="code-fetch" class="text-sm"></code></pre>
      </div>

      <div id="snippet-curl" class="code-snippet hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-semibold">cURL Example</span>
          <button class="btn btn-sm btn-ghost" onclick="copyCodeSnippet('curl')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Copy Code
          </button>
        </div>
        <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto"><code id="code-curl" class="text-sm"></code></pre>
      </div>
    </div>

    <!-- Instructions (Collapsible) -->
    <div class="collapse collapse-arrow bg-base-200 mt-6">
      <input type="checkbox" />
      <div class="collapse-title text-lg font-medium">
        ðŸ“– Detailed Instructions & Documentation
      </div>
      <div class="collapse-content">
        <div id="instructions-content" class="prose prose-sm max-w-none"></div>
      </div>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  let currentIntegrationData = null;

  function switchCodeTab(tab) {
    // Update tab styles
    document.querySelectorAll('[role="tab"]').forEach(t => {
      t.classList.toggle('tab-active', t.textContent.toLowerCase().includes(tab));
    });

    // Show/hide snippets
    document.querySelectorAll('.code-snippet').forEach(s => {
      s.classList.add('hidden');
    });
    document.getElementById(`snippet-${tab}`).classList.remove('hidden');
  }

  async function showIntegrationModal(modelSlug) {
    const response = await fetch(`/api/admin/tenants/${TENANT_SLUG}/integration/${modelSlug}`);
    const data = await response.json();
    currentIntegrationData = data;

    // Update title
    document.getElementById('integration-title').textContent = `${data.model.name} - API Integration`;

    // Update endpoint
    document.getElementById('endpoint-url').value = data.endpoint;

    // Update code snippets
    document.getElementById('code-javascript').textContent = data.snippets.javascript;
    document.getElementById('code-html').textContent = data.snippets.html;
    document.getElementById('code-fetch').textContent = data.snippets.fetch;
    document.getElementById('code-curl').textContent = data.snippets.curl;

    // Update instructions (convert markdown to HTML - simple version)
    document.getElementById('instructions-content').innerHTML =
      data.instructions.replace(/\n/g, '<br>').replace(/```json/g, '<pre class="bg-base-300 p-2 rounded"><code>').replace(/```/g, '</code></pre>');

    // Show modal
    document.getElementById('integration-modal').showModal();
  }

  function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');

    // Visual feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'âœ“ Copied!';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  }

  function copyCodeSnippet(type) {
    const code = document.getElementById(`code-${type}`).textContent;
    navigator.clipboard.writeText(code).then(() => {
      // Visual feedback
      const btn = event.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span class="text-success">âœ“ Copied!</span>';
      setTimeout(() => {
        btn.innerHTML = originalHTML;
      }, 2000);
    });
  }
</script>

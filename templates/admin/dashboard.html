<div class="min-h-screen bg-base-200">
  <!-- Navbar -->
  <div class="navbar bg-base-100 shadow-lg">
    <div class="flex-1">
      <a href="/admin" class="btn btn-ghost text-xl">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        dustCMS
      </a>
    </div>
    <div class="flex-none gap-2">
      <div class="badge badge-primary badge-lg">Super Admin</div>
      <button class="btn btn-ghost" onclick="logout()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
        Logout
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto p-6 max-w-7xl">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-2">Tenant Management</h1>
      <p class="text-base-content/70">Manage your multi-tenant CMS instances</p>
    </div>

    <!-- Stats -->
    <div class="stats stats-vertical lg:stats-horizontal shadow-lg mb-8 w-full">
      <div class="stat">
        <div class="stat-figure text-primary">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
        </div>
        <div class="stat-title">Total Tenants</div>
        <div class="stat-value text-primary" id="tenant-count">0</div>
        <div class="stat-desc">Active CMS instances</div>
      </div>

      <div class="stat">
        <div class="stat-figure text-secondary">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <div class="stat-title">Content Models</div>
        <div class="stat-value text-secondary" id="models-count">0</div>
        <div class="stat-desc">Across all tenants</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-4 mb-6">
      <button class="btn btn-primary gap-2" onclick="showCreateTenantModal()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Create New Tenant
      </button>
    </div>

    <!-- Tenants List -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">Your Tenants</h2>
        <div id="tenants-list" class="space-y-4">
          <!-- Tenants will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Tenant Modal -->
<dialog id="create-tenant-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Create New Tenant</h3>
    <form id="create-tenant-form" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Tenant Slug</span>
        </label>
        <input
          type="text"
          id="tenant-slug"
          class="input input-bordered"
          placeholder="acme-corp"
          pattern="[a-z0-9-]+"
          required
        />
        <label class="label">
          <span class="label-text-alt">Lowercase letters, numbers, and hyphens only</span>
        </label>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Tenant Name</span>
        </label>
        <input
          type="text"
          id="tenant-name"
          class="input input-bordered"
          placeholder="ACME Corporation"
          required
        />
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Client Password (Optional)</span>
        </label>
        <input
          type="text"
          id="tenant-password"
          class="input input-bordered"
          placeholder="Leave blank for auto-generated password"
        />
        <label class="label">
          <span class="label-text-alt">If left blank, a secure memorable password will be auto-generated</span>
        </label>
      </div>

      <div id="create-error" class="alert alert-error hidden">
        <span id="create-error-text"></span>
      </div>

      <div class="modal-action">
        <button type="button" class="btn" onclick="closeCreateTenantModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Tenant</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Tenant Welcome Modal -->
<dialog id="tenant-welcome-modal" class="modal">
  <div class="modal-box max-w-2xl">
    <h3 class="font-bold text-2xl mb-4">
      <svg class="w-8 h-8 inline-block text-success mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Tenant Created Successfully!
    </h3>

    <div class="space-y-4">
      <div class="alert alert-info">
        <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Send these credentials to your client to get them started</span>
      </div>

      <div class="bg-base-200 rounded-lg p-4">
        <h4 class="font-semibold mb-3 text-lg">Client Login Instructions</h4>
        <div id="tenant-credentials-text" class="font-mono text-sm whitespace-pre-wrap leading-relaxed">
          <!-- Credentials will be inserted here -->
        </div>
      </div>

      <div class="flex gap-2">
        <button class="btn btn-primary flex-1 gap-2" onclick="copyTenantCredentials()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
          Copy to Clipboard
        </button>
        <button class="btn btn-ghost" onclick="closeTenantWelcomeModal()">Done</button>
      </div>
    </div>
  </div>
</dialog>

<!-- Tenant Credentials Modal (View/Regenerate) -->
<dialog id="tenant-credentials-modal" class="modal">
  <div class="modal-box max-w-2xl">
    <h3 class="font-bold text-2xl mb-4" id="credentials-modal-title">Tenant Credentials</h3>

    <div class="space-y-4">
      <div class="alert alert-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
          <p class="font-semibold">Password Not Stored</p>
          <p class="text-sm">Passwords are hashed for security. You can generate a new password below.</p>
        </div>
      </div>

      <div class="bg-base-200 rounded-lg p-4">
        <h4 class="font-semibold mb-3 text-lg">Login Information</h4>
        <div id="credentials-info-text" class="font-mono text-sm whitespace-pre-wrap leading-relaxed">
          <!-- Credentials will be inserted here -->
        </div>
      </div>

      <div class="divider">Actions</div>

      <button class="btn btn-warning w-full gap-2" onclick="regenerateTenantPassword()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Generate New Password
      </button>

      <div class="modal-action">
        <button class="btn" onclick="closeTenantCredentialsModal()">Close</button>
      </div>
    </div>
  </div>
</dialog>

<script>
  let tenants = [];

  async function loadTenants() {
    try {
      const response = await fetch('/api/admin/tenants');
      const data = await response.json();
      tenants = data.tenants || [];
      renderTenants();
      updateStats();
    } catch (error) {
      console.error('Failed to load tenants:', error);
    }
  }

  function renderTenants() {
    const list = document.getElementById('tenants-list');
    if (tenants.length === 0) {
      list.innerHTML = `
        <div class="text-center py-12 text-base-content/50">
          <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
          <p class="text-lg">No tenants yet. Create your first one!</p>
        </div>
      `;
      return;
    }

    list.innerHTML = tenants.map(tenant => `
      <div class="card bg-base-200 hover:bg-base-300 transition-colors">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h3 class="card-title text-xl">${escapeHtml(tenant.name)}</h3>
              <p class="text-sm text-base-content/70 mt-1">
                <span class="font-mono bg-base-100 px-2 py-1 rounded">${escapeHtml(tenant.slug)}</span>
              </p>
              <p class="text-xs text-base-content/50 mt-2">
                Created: ${new Date(tenant.created_at).toLocaleDateString()}
              </p>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-info btn-sm gap-2" onclick="showTenantCredentialsModal('${escapeHtml(tenant.slug)}', '${escapeHtml(tenant.name)}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                </svg>
                Credentials
              </button>
              <a href="/admin/tenants/${encodeURIComponent(tenant.slug)}" class="btn btn-primary btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Manage
              </a>
              <button class="btn btn-error btn-sm btn-outline" onclick="deleteTenant('${escapeHtml(tenant.slug)}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function updateStats() {
    document.getElementById('tenant-count').textContent = tenants.length;
  }

  function showCreateTenantModal() {
    document.getElementById('create-tenant-modal').showModal();
  }

  function closeCreateTenantModal() {
    document.getElementById('create-tenant-modal').close();
    document.getElementById('create-tenant-form').reset();
    document.getElementById('create-error').classList.add('hidden');
  }

  let currentTenantCredentials = '';

  document.getElementById('create-tenant-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const slug = document.getElementById('tenant-slug').value.trim();
    const name = document.getElementById('tenant-name').value.trim();
    const password = document.getElementById('tenant-password').value.trim();

    // Build request body - only include password if provided
    const requestBody = { slug, name };
    if (password) {
      requestBody.password = password;
    }

    try {
      const response = await fetch('/api/admin/tenants', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const data = await response.json();

      if (response.ok) {
        closeCreateTenantModal();
        showTenantWelcomeModal(data.tenant);
        loadTenants();
      } else {
        document.getElementById('create-error-text').textContent = data.error || 'Failed to create tenant';
        document.getElementById('create-error').classList.remove('hidden');
      }
    } catch (error) {
      document.getElementById('create-error-text').textContent = 'Network error. Please try again.';
      document.getElementById('create-error').classList.remove('hidden');
    }
  });

  async function deleteTenant(slug) {
    if (!confirm(`Are you sure you want to delete tenant "${slug}"? This will delete all content and cannot be undone.`)) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/tenants/${slug}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        loadTenants();
      } else {
        alert('Failed to delete tenant');
      }
    } catch (error) {
      alert('Network error. Please try again.');
    }
  }

  function showTenantWelcomeModal(tenant) {
    // Get base domain from config (assuming it's available globally or hardcoded for now)
    const baseDomain = window.location.hostname === 'localhost' ? 'localhost:3000' : window.location.hostname;

    const credentials = `Welcome to dustCMS!

Your content management system is ready.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
LOGIN CREDENTIALS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Organization: ${tenant.name}
Login URL:    ${tenant.slug}.${baseDomain}
Username:     ${tenant.slug}
Password:     ${tenant.password}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
GETTING STARTED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Navigate to your login URL above
2. Sign in with your username and password
3. Create content models for your needs
4. Start managing your content!

For support, contact your system administrator.`;

    currentTenantCredentials = credentials;
    document.getElementById('tenant-credentials-text').textContent = credentials;
    document.getElementById('tenant-welcome-modal').showModal();
  }

  function closeTenantWelcomeModal() {
    document.getElementById('tenant-welcome-modal').close();
    currentTenantCredentials = '';
  }

  let currentCredentialsTenant = null;

  function showTenantCredentialsModal(slug, name) {
    currentCredentialsTenant = { slug, name };
    document.getElementById('credentials-modal-title').textContent = `${name} - Credentials`;

    const baseDomain = window.location.hostname === 'localhost' ? 'localhost:3000' : window.location.hostname;

    const info = `Organization: ${name}
Login URL:    ${slug}.${baseDomain}
Username:     ${slug}
Password:     (Click "Generate New Password" below)`;

    document.getElementById('credentials-info-text').textContent = info;
    document.getElementById('tenant-credentials-modal').showModal();
  }

  function closeTenantCredentialsModal() {
    document.getElementById('tenant-credentials-modal').close();
    currentCredentialsTenant = null;
  }

  async function regenerateTenantPassword() {
    if (!currentCredentialsTenant) return;

    if (!confirm('Generate a new password for this tenant? The old password will stop working.')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/tenants/${currentCredentialsTenant.slug}/regenerate-password`, {
        method: 'POST'
      });

      const data = await response.json();

      if (response.ok) {
        // Show the new password in a welcome-style modal
        closeTenantCredentialsModal();
        showTenantWelcomeModal({
          slug: currentCredentialsTenant.slug,
          name: currentCredentialsTenant.name,
          password: data.password
        });
      } else {
        alert('Failed to regenerate password: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      alert('Network error. Please try again.');
    }
  }

  async function copyTenantCredentials() {
    try {
      await navigator.clipboard.writeText(currentTenantCredentials);
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Copied!
      `;
      btn.classList.add('btn-success');
      btn.classList.remove('btn-primary');

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
      }, 2000);
    } catch (error) {
      alert('Failed to copy to clipboard. Please copy manually.');
    }
  }

  async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/admin/login';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load tenants on page load
  loadTenants();
</script>
